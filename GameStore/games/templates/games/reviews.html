{% extends 'base.html' %}
{% block content %}
<div class="reviews-page">
    <h1 class="page-title">{{title|capfirst}}</h1>
    
    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
    {% if user.is_authenticated %}
    <div class="add-review-section">
        <h2>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –æ–± –∏–≥—Ä–µ</h2>
        <form method="post" action="{% url 'add_review_ajax' %}" class="review-form" id="reviewForm">
            {% csrf_token %}
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ review_form.game.id_for_label }}">–ò–≥—Ä–∞:</label>
                    {{ review_form.game }}
                </div>
                <div class="form-group">
                    <label for="{{ review_form.rating.id_for_label }}">–û—Ü–µ–Ω–∫–∞:</label>
                    {{ review_form.rating }}
                </div>
            </div>
            <div class="form-group">
                <label for="{{ review_form.title.id_for_label }}">–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                {{ review_form.title }}
            </div>
            <div class="form-group">
                <label for="{{ review_form.text.id_for_label }}">–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞:</label>
                {{ review_form.text }}
            </div>
            <button type="submit" class="btn-primary" id="submitReview" style="margin-top: 20px;">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤</button>
        </form>
    </div>
    {% else %}
    <div class="auth-required">
        <p>–ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ <a href="{% url 'users:login' %}">–≤–æ–π–¥–∏—Ç–µ</a> –≤ —Å–∏—Å—Ç–µ–º—É.</p>
    </div>
    {% endif %}
    
    <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
    <div class="reviews-list">
        <h2>–û—Ç–∑—ã–≤—ã –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
        
        {% for review in reviews %}
        <div class="review-card" id="review-{{ review.id }}">
            <div class="review-header">
                <div class="review-author">
                    <strong>{{ review.user.username }}</strong>
                    <span class="review-date">{{ review.date|date:"d.m.Y H:i" }}</span>
                </div>
                <div class="review-rating">
                    –†–µ–π—Ç–∏–Ω–≥: 
                    <span class="stars">
                        {% with ""|center:review.rating as range %}
                        {% for i in range %}‚òÖ{% endfor %}
                        {% endwith %}
                    </span>
                    ({{ review.rating }}/5)
                </div>
            </div>
            
            {% if review.game %}
            <div class="review-game">
                –ò–≥—Ä–∞: 
                <a href="{% url 'game_detail' review.game.slug %}" class="game-link">
                    <strong>{{ review.game.title }}</strong>
                </a>
            </div>
            {% endif %}
            
            {% if review.title %}
            <h3 class="review-title">{{ review.title }}</h3>
            {% endif %}
            
            <div class="review-text">
                {{ review.text|linebreaks }}
            </div>
            
            <!-- –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ -->
            {% if user == review.user or perms.games.can_edit_all_reviews %}
            <div class="review-actions" style="margin-top: 20px;">
                <a href="{% url 'update_review' review.id %}" class="btn-edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{% url 'delete_review' review.id %}" class="btn-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="no-reviews">
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
        </div>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if page_obj.has_other_pages %}
    <nav class="list-pages">
        <ul>
            {% if page_obj.has_previous %}
            <li class="page-num">
                <a href="?page={{ page_obj.previous_page_number }}">–ù–∞–∑–∞–¥</a>
            </li>
            {% endif %}
            
            {% for p in paginator.page_range %}
                {% if page_obj.number == p %}
                <li class="page-num page-num-selected">{{ p }}</li>
                {% elif p >= page_obj.number|add:-2 and p <= page_obj.number|add:2 %}
                <li class="page-num">
                    <a href="?page={{ p }}">{{ p }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-num">
                <a href="?page={{ page_obj.next_page_number }}">–í–ø–µ—Ä–µ–¥</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- JavaScript –¥–ª—è AJAX –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitReview');
            const originalText = submitBtn.textContent;
            
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new FormData(this)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    reviewForm.reset();
                    // –ü—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });
    }
});
</script>
{% endblock %}