{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="game-detail-page">
    <div class="game-detail-card" style="max-width: 1000px; margin: 0 auto;">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã -->
        <div class="game-detail-header">
            <h1 class="page-title">{{ game.title }}</h1>
            {% if game.age_rating %}
            <span class="age-rating">{{ game.age_rating }}</span>
            {% endif %}
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="game-detail-content">
            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–≥—Ä—ã -->
            <div class="game-detail-image" style="flex: 0 0 400px;">
                {% if game.image %}
                <img src="{{ game.image.url }}" alt="{{ game.title }}" class="game-detail-img">
                {% else %}
                <img src="{% static 'games/images/default_game.jpg' %}" alt="{{ game.title }}" class="game-detail-img">
                {% endif %}
                
                <!-- –õ–∞–π–∫–∏ –∏ –¥–∏–∑–ª–∞–π–∫–∏-->
                <div class="game-likes" style="margin-top: 20px; justify-content: center; display: flex; gap: 15px;">
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'toggle_like' game.slug %}" class="like-form">
                        {% csrf_token %}
                        <input type="hidden" name="value" value="1">
                        <button type="submit" class="like-btn {% if user_reaction == 1 %}active{% endif %}" 
                                data-value="1" onclick="toggleLike(event, 1)">
                            üëç <span class="count">{{ likes_count }}</span>
                        </button>
                    </form>
                    
                    <form method="post" action="{% url 'toggle_like' game.slug %}" class="like-form">
                        {% csrf_token %}
                        <input type="hidden" name="value" value="-1">
                        <button type="submit" class="like-btn {% if user_reaction == -1 %}active{% endif %}" 
                                data-value="-1" onclick="toggleLike(event, -1)">
                            üëé <span class="count">{{ dislikes_count }}</span>
                        </button>
                    </form>
                    {% else %}
                    <div style="display: flex; gap: 10px;">
                        <span class="like-btn">üëç {{ likes_count }}</span>
                        <span class="like-btn">üëé {{ dislikes_count }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–µ -->
            <div class="game-detail-info" style="flex: 1; min-width: 0;">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="info-section">
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–µ</h3>
                    <p><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> {{ game.platform }}</p>
                    <p><strong>–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</strong> {{ game.year_release }}</p>
                    <p><strong>–¶–µ–Ω–∞:</strong> {{ game.price }} ‚ÇΩ</p>
                    
                    <!-- –°—Ç–∞—Ç—É—Å –Ω–∞–ª–∏—á–∏—è -->
                    {% if not game.is_stock %}
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span style="color: #ff0000;">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span></p>
                    {% endif %}
                </div>

                <!-- –ñ–∞–Ω—Ä—ã -->
                <div class="info-section">
                    <h3>–ñ–∞–Ω—Ä—ã</h3>
                    <div class="game-genres">
                        {% for genre in game.genres.all %}
                        <span class="genre-tag">{{ genre.name }}</span>
                        {% endfor %}
                    </div>
                </div>

                <!-- –¢–µ–≥–∏ -->
                <div class="info-section">
                    <h3>–¢–µ–≥–∏</h3>
                    <div class="game-tags">
                        {% for tag in game.tags.all %}
                        <a href="{% url 'catalog_by_tag' tag.slug %}" class="game-tag">
                            {{ tag.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- –¶–µ–Ω–∞ –∏ –∫–æ—Ä–∑–∏–Ω–∞ -->
                <div class="info-section">
                    <div class="price-cart-container">
                        <div class="price-section">
                            <div class="price">{{ game.price }} ‚ÇΩ</div>
                            {% if not game.is_stock %}
                            <div class="price_not_in_stock">
                                –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="cart-actions">
                            {% if user.is_authenticated and game.is_stock %}
                                {% if in_cart %}
                                <div class="in-cart-badge">
                                    ‚úì –í –∫–æ—Ä–∑–∏–Ω–µ
                                </div>
                                {% else %}
                                <form method="post" action="{% url 'add_to_cart' game.slug %}" class="add-to-cart-form" id="addToCartForm">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-success" id="addToCartBtn">
                                        –í –∫–æ—Ä–∑–∏–Ω—É
                                    </button>
                                </form>
                                {% endif %}
                            {% elif not user.is_authenticated and game.is_stock %}
                                <a href="{% url 'users:login' %}" class="btn-secondary" style="margin-left: -10px;">
                                    –í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –∫—É–ø–∏—Ç—å
                                </a>
                            {% endif %}
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
                    {% if perms.games.change_game %}
                    <div class="admin-actions">
                        <a href="{% url 'update_game' game.slug %}" class="btn-edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        <a href="{% url 'delete_game' game.slug %}" class="btn-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ –∏–≥—Ä—ã -->
        {% if game.description %}
        <div class="info-section" style="margin-top: 30px;">
            <h3>–û–ø–∏—Å–∞–Ω–∏–µ</h3>
            <p class="game-description">{{ game.description|linebreaks }}</p>
        </div>
        {% endif %}
    </div>

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    <div class="game-comments" style="max-width: 1000px; margin: 30px auto;">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments.count }})</h3>
        
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        {% if user.is_authenticated %}
        <div class="add-comment-form">
            <form method="post" action="{% url 'add_comment' game.slug %}" id="commentForm">
                {% csrf_token %}
                <div class="form-group">
                    {{ comment_form.text }}
                </div>
                <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </form>
        </div>
        {% else %}
        <div class="auth-required">
            <p>–ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ <a href="{% url 'users:login' %}">–≤–æ–π–¥–∏—Ç–µ</a> –≤ —Å–∏—Å—Ç–µ–º—É.</p>
        </div>
        {% endif %}

        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div class="comments-list">
            {% for comment in comments %}
            <div class="comment-card" id="comment-{{ comment.id }}">
                <div class="comment-header">
                    <strong>{{ comment.user.username }}</strong>
                    <span class="comment-date">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                </div>
                <div class="comment-text">
                    {{ comment.text|linebreaks }}
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∞–≤—Ç–æ—Ä –∏–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä) -->
                {% if user == comment.user or perms.games.can_edit_all_comments %}
                <div class="comment-actions">
                    <a href="#" class="btn-edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <a href="#" class="btn-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <div class="no-comments">
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
    <div class="back-link" style="max-width: 1000px; margin: 0 auto; text-align: center;">
        <a href="{% url 'catalog' %}" class="back-to-catalog">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
    </div>
</div>

<!-- JavaScript –¥–ª—è AJAX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
    const addToCartForm = document.getElementById('addToCartForm');
    
    if (addToCartForm) {
        addToCartForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('addToCartBtn');
            const originalText = submitBtn.textContent;
            
            // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ..."
            submitBtn.disabled = true;
            submitBtn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new FormData(this)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –ó–∞–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º—É –Ω–∞ –Ω–∞–¥–ø–∏—Å—å "–í –∫–æ—Ä–∑–∏–Ω–µ"
                    const cartBadge = document.createElement('div');
                    cartBadge.className = 'in-cart-badge';
                    cartBadge.style = 'background: #28a745; color: white; padding: 15px 25px; border-radius: 8px; font-weight: bold; font-size: 1.1em;';
                    cartBadge.textContent = '‚úì –í –∫–æ—Ä–∑–∏–Ω–µ';
                    
                    addToCartForm.replaceWith(cartBadge);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã –≤ —à–∞–ø–∫–µ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    const cartCount = document.querySelector('.cart-count');
                    if (cartCount && data.cart_total_items) {
                        cartCount.textContent = data.cart_total_items;
                    }
                } else {
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É');
                }
            })
            .catch(error => {
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É');
            });
        });
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new FormData(this)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    this.reset();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–∞–π–∫–æ–≤
function toggleLike(event, value) {
    event.preventDefault();
    
    const form = event.target.closest('form');
    const likeBtn = event.target;
    const countSpan = likeBtn.querySelector('.count');
    
    fetch(form.action, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new FormData(form)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            const likeBtns = document.querySelectorAll('.like-btn');
            likeBtns.forEach(btn => {
                const btnValue = parseInt(btn.getAttribute('data-value'));
                if (btnValue === data.current_value) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                if (btnValue === 1) {
                    btn.querySelector('.count').textContent = data.likes_count;
                } else if (btnValue === -1) {
                    btn.querySelector('.count').textContent = data.dislikes_count;
                }
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>
{% endblock %}